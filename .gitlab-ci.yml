image: python:3.7-alpine

stages:
  - test
  - post

#####################################################
#                    Test stage                     #
#####################################################

.tox-template: &tox
  stage: test
  before_script:
    - apk add --no-cache git make
    - pip3 install --upgrade pip tox
    - adduser -DH buildstream
    - chown -R buildstream:buildstream .
  script:
    - su buildstream -c 'tox -- --docker'
  services:
    - name: docker:dind
  variables: &tox-variables
    DOCKER_HOST: tcp://docker:2375/
    PY_COLORS: 1
    PYTEST_ADDOPTS: '--color=yes'

tests-py37:
  <<: *tox
  variables:
    <<: *tox-variables
    TOXENV: py37

tests-py36:
  <<: *tox
  image: python:3.6-alpine
  variables:
    <<: *tox-variables
    TOXENV: py36

tests-py35:
  <<: *tox
  image: python:3.5-alpine
  variables:
    <<: *tox-variables
    TOXENV: py35

lint:
  <<: *tox
  variables:
    <<: *tox-variables
    TOXENV: flake8, rst-lint

docs:
  <<: *tox
  variables:
    <<: *tox-variables
    TOXENV: docs
  script:
    - su buildstream -c tox
    - mv doc/build/html public
  artifacts:
    paths:
    - public/

#####################################################
#                  Post stage                       #
#####################################################

pages:
  stage: post
  dependencies:
  - docs
  # XXX: This script section is really a no-op but we need to have it since
  # GitLab CI mandates that the pages script can't be blank.
  script:
  - find public/
  artifacts:
    paths:
    - public/
  only:
  - master

release:
  stage: post
  before_script:
    - pip3 install --upgrade pip tox
  script:
    - tox -e release
  only:
    - tags
